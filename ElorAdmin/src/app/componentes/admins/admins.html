<div class="container my-3 admins">
  <h3>
    {{ isGod ? 'Gestión de Usuarios (incluye Administradores)' : 'Gestión de Usuarios (Secretaría)' }}
  </h3>

  <div class="toolbar">
    <div class="filters">
      <label>Tipo</label>
      <select [(ngModel)]="rolFiltro" (change)="cargar()">
        <option *ngFor="let r of allowedRoles" [value]="r">{{ r }}</option>
      </select>

      <input [(ngModel)]="q" (keyup.enter)="buscar()" placeholder="Buscar por nombre, apellidos o usuario" />
      <button class="btn btn-primary btn-sm" (click)="buscar()">Buscar</button>
    </div>

    <button class="btn btn-success btn-sm" (click)="nuevo()">Nuevo {{rolFiltro}}</button>
  </div>

  <div class="alert alert-danger py-1" *ngIf="error">{{error}}</div>

  <div class="table-responsive" *ngIf="!editMode">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Nombre</th>
          <th>Apellidos</th>
          <th>Email</th>
          <th>Rol</th>
          <th class="text-end" style="width:160px">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of paged">
          <td>{{u.username}}</td>
          <td>{{u.nombre}}</td>
          <td>{{u.apellidos}}</td>
          <td>{{u.email}}</td>
          <td>{{u.rol}}</td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-sm me-2" (click)="editar(u)">Editar</button>
            <button class="btn btn-outline-danger btn-sm" (click)="borrar(u)">Borrar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination-wrap">
      <button class="btn btn-light btn-sm" [disabled]="page===1" (click)="page=page-1">Anterior</button>
      <span>Página {{page}}</span>
      <button class="btn btn-light btn-sm" [disabled]="page*pageSize>=usuarios.length" (click)="page=page+1">Siguiente</button>
      <span class="ms-auto small text-muted">Resultados: {{usuarios.length}}</span>
    </div>
  </div>

  <div class="card p-3" *ngIf="editMode">
    <h5 class="mb-2">{{form.id ? 'Editar' : 'Nuevo'}} {{rolFiltro}}</h5>
    <div class="row g-2">
      <div class="col-md-6">
        <label>Usuario</label>
        <input [(ngModel)]="form.username" class="form-control" />
      </div>
      <div class="col-md-6">
        <label>Email</label>
        <input [(ngModel)]="form.email" class="form-control" />
      </div>
      <div class="col-md-6">
        <label>Nombre</label>
        <input [(ngModel)]="form.nombre" class="form-control" />
      </div>
      <div class="col-md-6">
        <label>Apellidos</label>
        <input [(ngModel)]="form.apellidos" class="form-control" />
      </div>
      <div class="col-md-6">
        <label>Rol</label>
        <select [(ngModel)]="form.rol" class="form-select">
          <option value="profesor">Profesor</option>
          <option value="alumno">Alumno</option>
          <option *ngIf="isGod" value="administrador">Administrador</option>
        </select>
      </div>
      <div class="col-md-6">
        <label>Contraseña</label>
        <input [(ngModel)]="form.password" class="form-control" type="password" placeholder="{{ form.id ? 'Dejar en blanco para no cambiar' : 'Obligatoria' }}" />
      </div>
    </div>
    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-success btn-sm" (click)="guardar()">Guardar</button>
      <button class="btn btn-secondary btn-sm" (click)="cancelar()">Cancelar</button>
    </div>
  </div>
</div>